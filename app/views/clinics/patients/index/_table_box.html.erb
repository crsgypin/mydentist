<%= form_tag new_clinic_event_notification_schedule_path(@clinic), method: "get", id: "patient_table_box", remote: true do %>
  <%= hidden_field_tag "event_notification_schedule[category]", "回診推播" %>
  <%= hidden_field_tag "event_notification_schedule[schedule_type]", "立即發送" %>
  <%= render partial: "clinics/common/clinic_table" , locals: {
    id: "patients",
    class: "ht80",
    resources: @patients,
    cols: proc do 
      r = [
        {t: "病患姓名", v: proc{|a| "#{a.name} #{a.id}" }},
        {t: "性別", v: proc{|a| a.gender }},
        {t: "身分證號碼", v: proc{|a| a.person_id }},
        {t: "出生年月日", v: proc{|a| roc_format(a.birthday, 3) }},
        {t: "聯絡電話", v: proc{|a| a.phone }},
        {t: "看診醫生", v: proc{|a|
          if a.default_doctor
            a.default_doctor.name
          else
            ""
          end
        }},
        {t: "已可洗牙", v: proc{|a| 
          if a.available_for_tooth_cleaning 
            icon_tag(:circle, class: 'colorBu')
          else
            ""
          end
        }},
        {t: "下次就診日期", v: proc{|a| a.current_event.try(:date) }},
      ]

      if @category == "all"
        r += [
          {t: "加入推播狀態", unclickable: true, v: proc{|a| 
            render_relative_partial "table_box/notification", locals: {patient: a}
          }}
        ]
      end
      if @category == "notification"
        r = [
          {t: check_box_tag("", "", false, class: "notification_check_all"), unclickable: true, v: proc{ |a, index| 
              r = check_box_tag("event_notification_schedule[notifications_attributes][#{index}][patient_id]", a.id, false, class: "notification_check")
              r += check_box_tag("event_notification_schedule[notifications_attributes][#{index}][args]", {clinic_name: @clinic.name,patient_name: a.name}.to_json, false, class: "hidden")
              r.html_safe
            }
          }
        ] + r
      end
     r
   end.call,
    row: {
      link: proc do |a|
        url_for(action: :show, id: a)
      end
    }
  }
  %>
<% end %>

<script type="text/javascript">
  $(function(){
    $("#patients_index").on("change", ".notification_check", function(){
      updateChecked(this);
      updateCount();
    });
    $("#patients_index").on("change", ".notification_check_all", function(){
      var checked = this.checked;
      $("#patients_index .notification_check").each(function(i, elm){
        $(elm)[0].checked = checked;
        updateChecked(elm);
      })
      updateCount();
    });

    window.pushNotification = function(){
      var eventIds = 
      $.ajax({
        url: "<%= new_clinic_event_notification_schedule_path(@clinic) %>",
        method: "get",
        data: {
          event_notification_schedule: {
            category: 
            notifications_attributes: {
              
            }
          }
        }
      })
    }

    function updateChecked(input){
      var checked = input.checked;
      $(input).siblings().each(function(i, elm){
        elm.checked = checked;
      })
    }

    function updateCount(){
      var count = $("#patients_index .notification_check:checked").length;
      $("#search_box .number").text(count);
    }
  })
</script>


