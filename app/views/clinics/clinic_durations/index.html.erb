
<div id="clinic-durations-index">
	<div class="title-box">
	</div>
	<div class="content-box">
		<%= form_tag url_for(action: :create), method: "post", remote: true do %>
		<table id="duration-table">
			<tr class="title">
				<th></th>
				<% [1,2,3,4,5,6,0].each do |wd| %>
				<th>
					<div class="btnGy_d"><%= ch_wday(wd) %></div>
				</th>
				<% end %>
			</tr>
			<% row = 0 %>
			<% (6..23).each do |hour| %>
			<% [0, 30].each do |minute| %>
			<tr class="content">
				<td class="title">
					<span><%= minute == 0 ? hour_minute_format(hour, minute) : "" %></span>
				</td>
				<% [1,2,3,4,5,6,0].each_with_index do |wday, col| %>
				<% duration_include = duration_include?(@clinic_durations, wday, hour, minute) %>
				<td class= "content <%= "#{minute == 0 ? "solid" : "dashed"}" %>">
					<%= check_box_tag "clinic_duration[][wday_hour_minute]", "#{wday}_#{hour_minute_format(hour, minute)}", duration_include %>
					<%= content_tag :div, data: {row: row, col: col}, class: "reveal", id: "reveal-#{row}-#{col}" do %>
					<% end %>
				</td>
				<% end %>
			</tr>
			<% row += 1 %>
			<% end %>
			<% end %>
		</table>
		<div class="buttons-box">
			<%= submit_tag "儲存", class: "btnBu" %>
		</div>
		<% end %>
	</div>
</div>

<script type="text/javascript">
	$(function(){
		var tableBox = $("#duration-table");
		var selecting = {
			mode: "idle",
			selectedToTrue: null,
			startPoint: null,
			endPoint: null
		};
		tableBox.find("tr.content td.content .reveal").on("mousedown", function(e){
			var row = $(this).data('row');
			var col = $(this).data('col');
			selecting = {
				mode: "selecting",
				selectedToTrue: !$(this).siblings("input")[0].checked,
				startPoint: {row: row, col: col},
				endPoint: {row: row, col: col}
			}
			updateSelectingReveal();
		});
		tableBox.find("tr.content td.content .reveal").on("mouseover", function(e){
			console.log("mouseover");
			if(selecting.mode == "selecting"){
				var row = $(this).data('row');
				var col = $(this).data('col');
				selecting.endPoint = {row: row, col: col};
				updateSelectingReveal();
			}
		});
		$(document).on("mouseup", function(e){
			tableBox.find(".selecting_to_true").each(function(i, elm){
				$(elm).siblings("input")[0].checked = true;
			});
			tableBox.find(".selecting_to_false").each(function(i, elm){
				$(elm).siblings("input")[0].checked = false;
			});
			selecting = {
				mode: "idle",
				selectedToTrue: null,
				startPoint: null,
				endPoint: null
			}
			clearSelectingReveal();
		});
		var updateSelectingReveal = function(){
			if(selecting.mode == "selecting"){
				var ranges = getSelectingRange(selecting.startPoint, selecting.endPoint);
				var ids = ranges.map(function(range){
					return "reveal-" + range.row + "-" + range.col;
				});
				clearSelectingReveal();
				ids.forEach(function(id){
					if(selecting.selectedToTrue){
						$("#" + id).addClass("selecting_to_true");
					} else {
						$("#" + id).addClass("selecting_to_false");
					}
				})
			}
		};
		var clearSelectingReveal = function(){
			tableBox.find(".reveal").removeClass("selecting_to_true").removeClass("selecting_to_false");
		};
		window.getSelectingRange = function(startPoint, endPoint){
			var selRanges = [];
			var r = Math.min(startPoint.row, endPoint.row);
			var eRow = Math.max(startPoint.row, endPoint.row);
			do {
				var c = Math.min(startPoint.col, endPoint.col);
				var eCol = Math.max(startPoint.col, endPoint.col);
				do {
					selRanges.push({
						row: r,
						col: c
					});
					c += 1;
				} while(c <= eCol);
				r += 1;
			} while(r <= eRow);
			return selRanges;
		}
	})
</script>
