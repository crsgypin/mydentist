
<% hour_segments.each do |hour_segment| %>
<% hour = hour_segment[:hour] %>
<% hour_segment[:minute_segments].each_with_index do |minute_segment, index| %>
  <% minute = minute_segment[:minute] %>
  <% events = minute_segment[:events] %>
	<% border_style ={0 => "border3", 15 => "border2", 30 => "border3", 45 => "border1"}[minute] %>
	<% zindex = 100 + index %>
	<div class="d_row hour_minute_tr <%= border_style %>" data-hour="<%= hour %>" style="margin-left: -20px; margin-right: -20px; height: <%= row_height %>px;">
	  <% if events.length > 0 %>
	  	<% select_events = events.select {|e| e.hour == hour && e.minute == minute && e.is_valid_in_line? } %>
			<% width = "#{80 / select_events.length}%" if select_events.length > 0 %>
  		<% select_events.each do |event| %>
	    <div class="patient_event exist" 
	    	data-id="<%= event.id %>"
	      style="height: <%= event.event_durations_count * row_height %>px; z-index: <%= zindex %>; width: <%= width %>;" 
	      onclick="<%= onclick_event.call(event) %>">
	      <% if event.expired? %>
				<div class="expired_cover"></div>
	      <% end %>
	      <div class="info">
		      <div class="patient"><%= event.patient.name %></div>
		      <div class="service"><%= event.service.name %></div>
		    </div>
	      <div class="status">
	      	<div class="line_box <%= "selected" if event.source == "網路" %>" id= "<%= "check_id_#{event.id}"%>">
	      		<%= image_tag clinic_static_image_url(:line_bot) %>
	      	</div>
	        <div class="check_in <%= "selected" if event.status == "報到" %>" id= "<%= "check_id_#{event.id}"%>">
	        	<%= image_tag clinic_static_image_url(:checked_green) %>
	        </div>
	        <div class="break <%= "selected" if event.status == "爽約" %>" id="<%= "break_#{event.id}" %>">
	        	<%= image_tag clinic_static_image_url(:cross_red) %>
        	</div>
	      </div>
	    </div>
	    <% end %>
	  <% else %>
	  <div class="patient_event"
	  	data-doctor_id="<%= doctor.id %>"
	  	data-date="<%= @date %>" 
	  	data-hour="<%= hour %>"
	  	data-minute="<%= minute %>"
	  	style="height: <%= row_height %>px; z-index: <%= zindex %>; width: 100%;" 
	  	onclick="<%= onclick_new_event.call(hour, minute) %>">
	  </div>
	  <% end %>
	</div>
<% end %>
<% end %>

